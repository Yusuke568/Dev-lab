# 勤務報告書テンプレート化システム要件定義書
## 05. データ定義書

### 5.1 データベース設計概要

#### 5.1.1 設計方針
- 既存システム（STAFF_TABLE, CLASS_MASTER）との互換性維持
- 正規化によるデータの整合性確保
- インデックス設計による性能最適化
- 拡張性を考慮したテーブル設計

#### 5.1.2 データベース構成
- **データベース名**: timecard_system
- **文字セット**: UTF-8
- **照合順序**: utf8mb4_general_ci
- **ストレージエンジン**: InnoDB

### 5.2 既存テーブル仕様

#### 5.2.1 CLASS_MASTER（役職マスタ）
**概要**: 社員の役職情報を管理

| 列名 | データ型 | 制約 | 説明 |
|------|---------|------|------|
| ID | VARCHAR(40) | PRIMARY KEY | 役職区分 |
| NAME | VARCHAR(40) | | 役職名称 |

**インデックス**:
- PRIMARY KEY (ID)

---

#### 5.2.2 STAFF_TABLE（社員テーブル）
**概要**: 社員基本情報を管理

| 列名 | データ型 | 制約 | 説明 |
|------|---------|------|------|
| ID | INT | PRIMARY KEY | 社員ID |
| NAME | VARCHAR(40) | | 社員名 |
| NAMEKANA | VARCHAR(40) | | 社員名カナ |
| ENTRY_YEAR | INT | | 入社年 |
| GENDER | VARCHAR(10) | | 性別 |
| CLASS_ID | VARCHAR(40) | FOREIGN KEY | 役職区分 |

**外部キー制約**:
- FOREIGN KEY (CLASS_ID) REFERENCES CLASS_MASTER(ID) ON UPDATE CASCADE

**インデックス**:
- PRIMARY KEY (ID)
- INDEX idx_class_id (CLASS_ID)

### 5.3 新規テーブル仕様

#### 5.3.1 WORKPLACE_MASTER（配属先マスタ）
**概要**: 配属先の基本情報と休憩時間設定を管理

```sql
CREATE TABLE WORKPLACE_MASTER (
    WORKPLACE_ID VARCHAR(20) PRIMARY KEY COMMENT '配属先ID',
    WORKPLACE_NAME VARCHAR(100) NOT NULL COMMENT '配属先名称',
    BREAK_START_TIME TIME COMMENT '休憩開始時刻',
    BREAK_END_TIME TIME COMMENT '休憩終了時刻',
    STANDARD_WORK_HOURS DECIMAL(3,1) DEFAULT 8.0 COMMENT '標準勤務時間',
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '作成日時',
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新日時'
) COMMENT '配属先マスタ';
```

**サンプルデータ**:
| WORKPLACE_ID | WORKPLACE_NAME | BREAK_START_TIME | BREAK_END_TIME | STANDARD_WORK_HOURS |
|-------------|---------------|-----------------|---------------|-------------------|
| WP001 | 開発部A | 12:00:00 | 13:00:00 | 8.0 |
| WP002 | 開発部B | 12:30:00 | 13:30:00 | 8.0 |
| WP003 | 営業部 | 11:30:00 | 12:30:00 | 7.5 |

---

#### 5.3.2 STAFF_WORKPLACE（社員配属情報）
**概要**: 社員の配属先履歴を管理

```sql
CREATE TABLE STAFF_WORKPLACE (
    ID INT PRIMARY KEY AUTO_INCREMENT COMMENT 'ID',
    STAFF_ID INT NOT NULL COMMENT '社員ID',
    WORKPLACE_ID VARCHAR(20) NOT NULL COMMENT '配属先ID',
    START_DATE DATE NOT NULL COMMENT '配属開始日',
    END_DATE DATE COMMENT '配属終了日',
    IS_ACTIVE BOOLEAN DEFAULT TRUE COMMENT '有効フラグ',
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '作成日時',
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新日時',
    FOREIGN KEY (STAFF_ID) REFERENCES STAFF_TABLE(ID) ON UPDATE CASCADE,
    FOREIGN KEY (WORKPLACE_ID) REFERENCES WORKPLACE_MASTER(WORKPLACE_ID) ON UPDATE CASCADE
) COMMENT '社員配属情報';
```

**インデックス**:
- PRIMARY KEY (ID)
- INDEX idx_staff_id (STAFF_ID)
- INDEX idx_workplace_id (WORKPLACE_ID)
- INDEX idx_active_date (IS_ACTIVE, START_DATE, END_DATE)

---

#### 5.3.3 TIMECARD_RECORD（勤務記録）
**概要**: 日次勤務記録の基本情報を管理

```sql
CREATE TABLE TIMECARD_RECORD (
    ID INT PRIMARY KEY AUTO_INCREMENT COMMENT 'ID',
    STAFF_ID INT NOT NULL COMMENT '社員ID',
    WORK_DATE DATE NOT NULL COMMENT '勤務日',
    CLOCK_IN_TIME TIME COMMENT '出勤時刻',
    CLOCK_OUT_TIME TIME COMMENT '退勤時刻',
    BREAK_START_TIME TIME COMMENT '休憩開始時刻',
    BREAK_END_TIME TIME COMMENT '休憩終了時刻',
    ACTUAL_WORK_HOURS DECIMAL(4,2) COMMENT '実働時間',
    OVERTIME_HOURS DECIMAL(4,2) DEFAULT 0.00 COMMENT '時間外労働時間',
    WORK_TYPE VARCHAR(20) DEFAULT '通常勤務' COMMENT '勤務区分',
    STATUS VARCHAR(20) DEFAULT '下書き' COMMENT '状態',
    COMMENTS TEXT COMMENT 'コメント・所感',
    INDIRECT_HOURS DECIMAL(4,2) DEFAULT 0.00 COMMENT '間接時間',
    ADJUSTMENT_HOURS DECIMAL(4,2) DEFAULT 0.00 COMMENT '稼働調整時間',
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '作成日時',
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新日時',
    FOREIGN KEY (STAFF_ID) REFERENCES STAFF_TABLE(ID) ON UPDATE CASCADE,
    UNIQUE KEY uk_staff_date (STAFF_ID, WORK_DATE)
) COMMENT '勤務記録';
```

**勤務区分値域**:
- 通常勤務
- 時間外勤務  
- 有給休暇
- 半休
- 欠勤
- 振替休日

**状態値域**:
- 下書き
- 提出済み
- 承認済み
- 差し戻し

**インデックス**:
- PRIMARY KEY (ID)
- UNIQUE KEY uk_staff_date (STAFF_ID, WORK_DATE)
- INDEX idx_work_date (WORK_DATE)
- INDEX idx_status (STATUS)
- INDEX idx_work_type (WORK_TYPE)

---

#### 5.3.4 OVERTIME_REQUEST（時間外申請）
**概要**: 時間外勤務申請の詳細情報を管理

```sql
CREATE TABLE OVERTIME_REQUEST (
    ID INT PRIMARY KEY AUTO_INCREMENT COMMENT 'ID',
    TIMECARD_RECORD_ID INT NOT NULL COMMENT '勤務記録ID',
    REQUEST_TYPE VARCHAR(20) NOT NULL COMMENT '申請種別',
    PLANNED_START_TIME TIME COMMENT '予定開始時刻',
    PLANNED_END_TIME TIME COMMENT '予定終了時刻',
    ACTUAL_START_TIME TIME COMMENT '実際開始時刻',
    ACTUAL_END_TIME TIME COMMENT '実際終了時刻',
    REASON TEXT NOT NULL COMMENT '申請理由',
    APPROVAL_STATUS VARCHAR(20) DEFAULT '申請中' COMMENT '承認状態',
    APPROVER_ID INT COMMENT '承認者ID',
    APPROVED_AT TIMESTAMP NULL COMMENT '承認日時',
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '作成日時',
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新日時',
    FOREIGN KEY (TIMECARD_RECORD_ID) REFERENCES TIMECARD_RECORD(ID) ON DELETE CASCADE,
    FOREIGN KEY (APPROVER_ID) REFERENCES STAFF_TABLE(ID) ON UPDATE CASCADE
) COMMENT '時間外申請';
```

**申請種別値域**:
- 事前申請
- 事後申請

**承認状態値域**:
- 申請中
- 承認済み
- 却下
- 取り下げ

**インデックス**:
- PRIMARY KEY (ID)
- INDEX idx_timecard_record_id (TIMECARD_RECORD_ID)
- INDEX idx_approval_status (APPROVAL_STATUS)
- INDEX idx_approver_id (APPROVER_ID)

---

#### 5.3.5 VACATION_REQUEST（休暇申請）
**概要**: 有給休暇等の申請情報を管理

```sql
CREATE TABLE VACATION_REQUEST (
    ID INT PRIMARY KEY AUTO_INCREMENT COMMENT 'ID',
    STAFF_ID INT NOT NULL COMMENT '社員ID',
    VACATION_TYPE VARCHAR(20) NOT NULL COMMENT '休暇種別',
    START_DATE DATE NOT NULL COMMENT '開始日',
    END_DATE DATE NOT NULL COMMENT '終了日',
    DAYS_COUNT DECIMAL(3,1) NOT NULL COMMENT '取得日数',
    REASON TEXT COMMENT '申請理由',
    APPROVAL_STATUS VARCHAR(20) DEFAULT '申請中' COMMENT '承認状態',
    APPROVER_ID INT COMMENT '承認者ID',
    APPROVED_AT TIMESTAMP NULL COMMENT '承認日時',
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '作成日時',
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新日時',
    FOREIGN KEY (STAFF_ID) REFERENCES STAFF_TABLE(ID) ON UPDATE CASCADE,
    FOREIGN KEY (APPROVER_ID) REFERENCES STAFF_TABLE(ID) ON UPDATE CASCADE
) COMMENT '休暇申請';
```

**休暇種別値域**:
- 有給休暇
- 半休
- 特別休暇
- 振替休日

**インデックス**:
- PRIMARY KEY (ID)
- INDEX idx_staff_id (STAFF_ID)
- INDEX idx_date_range (START_DATE, END_DATE)
- INDEX idx_approval_status (APPROVAL_STATUS)

---

#### 5.3.6 TEMPLATE_MASTER（テンプレートマスタ）
**概要**: コメント用定型文テンプレートを管理

```sql
CREATE TABLE TEMPLATE_MASTER (
    ID INT PRIMARY KEY AUTO_INCREMENT COMMENT 'ID',
    TEMPLATE_NAME VARCHAR(100) NOT NULL COMMENT 'テンプレート名',
    TEMPLATE_CONTENT TEXT NOT NULL COMMENT 'テンプレート内容',
    CATEGORY VARCHAR(50) COMMENT 'カテゴリ',
    IS_SYSTEM_TEMPLATE BOOLEAN DEFAULT FALSE COMMENT 'システム標準テンプレートフラグ',
    STAFF_ID INT COMMENT '作成者ID',
    IS_ACTIVE BOOLEAN DEFAULT TRUE COMMENT '有効フラグ',
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '作成日時',
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新日時',
    FOREIGN KEY (STAFF_ID) REFERENCES STAFF_TABLE(ID) ON UPDATE CASCADE
) COMMENT 'テンプレートマスタ';
```

**サンプルデータ**:
| TEMPLATE_NAME | TEMPLATE_CONTENT | CATEGORY |
|--------------|-----------------|----------|
| 開発作業標準 | システム開発作業を実施しました。進捗は予定通りです。 | 開発 |
| 会議参加標準 | プロジェクト会議に参加しました。議事録を確認し対応予定です。 | 会議 |
| 学習・研修 | 技術研修に参加しました。習得内容を実務に活用予定です。 | 研修 |

---

#### 5.3.7 NOTIFICATION_LOG（通知ログ）
**概要**: システムからの通知履歴を管理

```sql
CREATE TABLE NOTIFICATION_LOG (
    ID INT PRIMARY KEY AUTO_INCREMENT COMMENT 'ID',
    STAFF_ID INT NOT NULL COMMENT '通知対象社員ID',
    NOTIFICATION_TYPE VARCHAR(50) NOT NULL COMMENT '通知種別',
    TITLE VARCHAR(200) NOT NULL COMMENT '通知タイトル',
    MESSAGE TEXT NOT NULL COMMENT '通知メッセージ',
    IS_READ BOOLEAN DEFAULT FALSE COMMENT '既読フラグ',
    NOTIFICATION_METHOD VARCHAR(20) NOT NULL COMMENT '通知方法',
    SENT_AT TIMESTAMP NOT NULL COMMENT '送信日時',
    READ_AT TIMESTAMP NULL COMMENT '既読日時',
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '作成日時',
    FOREIGN KEY (STAFF_ID) REFERENCES STAFF_TABLE(ID) ON UPDATE CASCADE
) COMMENT '通知ログ';
```

**通知種別値域**:
- 入力忘れアラート
- 提出期限警告
- 承認完了通知
- システムメンテナンス

**通知方法値域**:
- システム内通知
- メール
- プッシュ通知

**インデックス**:
- PRIMARY KEY (ID)
- INDEX idx_staff_id (STAFF_ID)
- INDEX idx_notification_type (NOTIFICATION_TYPE)
- INDEX idx_is_read (IS_READ)
- INDEX idx_sent_at (SENT_AT)

---

#### 5.3.8 SYSTEM_SETTINGS（システム設定）
**概要**: システム全体の設定値を管理

```sql
CREATE TABLE SYSTEM_SETTINGS (
    ID INT PRIMARY KEY AUTO_INCREMENT COMMENT 'ID',
    SETTING_KEY VARCHAR(100) NOT NULL UNIQUE COMMENT '設定キー',
    SETTING_VALUE TEXT NOT NULL COMMENT '設定値',
    SETTING_TYPE VARCHAR(20) NOT NULL COMMENT '設定タイプ',
    DESCRIPTION TEXT COMMENT '説明',
    IS_ACTIVE BOOLEAN DEFAULT TRUE COMMENT '有効フラグ',
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '作成日時',
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新日時'
) COMMENT 'システム設定';
```

**サンプル設定値**:
| SETTING_KEY | SETTING_VALUE | SETTING_TYPE | DESCRIPTION |
|------------|--------------|-------------|-------------|
| notification_time_daily | 18:00:00 | TIME | 日次未入力通知時刻 |
| notification_time_weekly | WED 10:00:00 | STRING | 週次コメント促進通知 |
| max_overtime_hours | 45.0 | DECIMAL | 月次時間外労働上限 |
| auto_break_calculation | true | BOOLEAN | 自動休憩時間計算フラグ |

**インデックス**:
- PRIMARY KEY (ID)
- UNIQUE KEY uk_setting_key (SETTING_KEY)

### 5.4 ビューおよびストアドプロシージャ

#### 5.4.1 V_STAFF_CURRENT_WORKPLACE（現在配属先ビュー）
**概要**: 社員の現在の配属先情報を取得

```sql
CREATE VIEW V_STAFF_CURRENT_WORKPLACE AS
SELECT 
    st.ID as STAFF_ID,
    st.NAME as STAFF_NAME,
    sw.WORKPLACE_ID,
    wm.WORKPLACE_NAME,
    wm.BREAK_START_TIME,
    wm.BREAK_END_TIME,
    wm.STANDARD_WORK_HOURS
FROM STAFF_TABLE st
LEFT JOIN STAFF_WORKPLACE sw ON st.ID = sw.STAFF_ID
LEFT JOIN WORKPLACE_MASTER wm ON sw.WORKPLACE_ID = wm.WORKPLACE_ID
WHERE sw.IS_ACTIVE = TRUE 
  AND (sw.END_DATE IS NULL OR sw.END_DATE >= CURDATE());
```

---

#### 5.4.2 V_MONTHLY_TIMECARD_SUMMARY（月次勤務サマリービュー）
**概要**: 月次の勤務実績サマリーを取得

```sql
CREATE VIEW V_MONTHLY_TIMECARD_SUMMARY AS
SELECT 
    tr.STAFF_ID,
    st.NAME as STAFF_NAME,
    YEAR(tr.WORK_DATE) as YEAR,
    MONTH(tr.WORK_DATE) as MONTH,
    COUNT(*) as WORK_DAYS,
    SUM(tr.ACTUAL_WORK_HOURS) as TOTAL_WORK_HOURS,
    SUM(tr.OVERTIME_HOURS) as TOTAL_OVERTIME_HOURS,
    COUNT(CASE WHEN tr.WORK_TYPE = '有給休暇' THEN 1 END) as VACATION_DAYS,
    AVG(tr.ACTUAL_WORK_HOURS) as AVG_WORK_HOURS
FROM TIMECARD_RECORD tr
INNER JOIN STAFF_TABLE st ON tr.STAFF_ID = st.ID
WHERE tr.STATUS IN ('提出済み', '承認済み')
GROUP BY tr.STAFF_ID, st.NAME, YEAR(tr.WORK_DATE), MONTH(tr.WORK_DATE);
```

### 5.5 データマイグレーション計画

#### 5.5.1 移行対象データ
1. **既存勤怠データ**: 現行システムからTIMECARD_RECORDへ
2. **社員配属情報**: 手動設定からSTAFF_WORKPLACEへ
3. **システム設定**: 現行設定値からSYSTEM_SETTINGSへ

#### 5.5.2 移行手順
1. **Phase1**: 新テーブル作成とインデックス設定
2. **Phase2**: マスタデータの移行（配属先、設定値）
3. **Phase3**: 過去1年分の勤怠データ移行
4. **Phase4**: データ整合性チェックと修正
5. **Phase5**: 本番移行と切り替え

### 5.6 データメンテナンス

#### 5.6.1 定期メンテナンス
- **月次**: インデックス最適化、統計情報更新
- **年次**: 古いログデータのアーカイブ
- **随時**: データ整合性チェック

#### 5.6.2 バックアップ戦略
- **フルバックアップ**: 毎日曜日深夜
- **差分バックアップ**: 毎日深夜
- **トランザクションログ**: 15分間隔

#### 5.6.3 データ保持期間
| テーブル | 保持期間 | アーカイブ方法 |
|---------|---------|---------------|
| TIMECARD_RECORD | 3年 | 年次テーブル分割 |
| NOTIFICATION_LOG | 1年 | 月次削除 |
| OVERTIME_REQUEST | 5年 | 年次アーカイブ |
| VACATION_REQUEST | 5年 | 年次アーカイブ |

### 5.7 セキュリティ考慮事項

#### 5.7.1 アクセス権限
- **読み取り専用**: 一般社員（自分のデータのみ）
- **更新権限**: 一般社員（自分のデータのみ）
- **管理権限**: 管理者（全データ）

#### 5.7.2 データ暗号化
- 個人情報カラムの暗号化（NAME, NAMEKANA）
- パスワード関連情報のハッシュ化
- 通信暗号化（TLS1.2以上）

#### 5.7.3 監査ログ
- データ変更履歴の記録
- アクセスログの保管
- 不正アクセス検知

---
*文書作成日: 2025年9月14日*  
*文書バージョン: 1.0*